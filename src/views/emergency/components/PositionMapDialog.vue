<template>
  <a-modal wrapClassName="positionMapDialogWrap"
           title="位置选择"
           v-model="mapDialogVisible"
           width="80%"
           :maskClosable="false"
           @cancel="handleCancel"
           :bodyStyle="{padding:'0px 5px 5px 5px',borderRadius:'7px',overFlow: 'hidden'}"
           style="top:57px"
           :destroyOnClose="true"
           :footer="null"
  >
    <div class="yuan_dialog_body">
      <!-- 地图控件注入地址 -->
      <LayoutMap ref="olMap"></LayoutMap>
      <div class="upload">
        <a-button type="primary" icon="cloud-upload" @click="uploadPoint"></a-button>
      </div>
    </div>
  </a-modal>
</template>
<script type="text/ecmascript-6">
  import LayoutMap from '@/views/position/olMap.vue'
  // import { MapManager,filterMapId } from '@/utils/util.map.manage'
  import {Draw, Modify, Snap} from 'ol/interaction.js';
  import {Vector as VectorLayer} from 'ol/layer.js';
  import {Vector as VectorSource} from 'ol/source.js';
  import { Style} from 'ol/style.js';
  import Icon from 'ol/style/Icon';
  import {getAddress} from '@/api/map/service'
  import Feature from 'ol/Feature'
  import Point from 'ol/geom/Point'
  let map;
  let source;
    export default{
      name: 'positionMapDialog',
      components: {
        LayoutMap
      },
      props:{
        visible: {
            type: Boolean,
            default: false
        },
        positionData:{
          type: Object,
          default(){
            return {}
          }
        }
      },
      data(){
        return {
            mapDialogVisible: false
        }
      },
      computed:{

      },
      watch:{
        mapDialogVisible:function(val){
          if(val){
            this.init();
          }
          else{
            this.$emit('update:visible', false);
          }
        },
        visible:function(val){
          if(val){
            this.mapDialogVisible = true;
          }
        },
      },
      methods:{
        init(){
          this.$nextTick().then(() => {
            console.log('位置信息',this.positionData)
            map = this.$refs.olMap.getMap();
            source = new VectorSource();
            let vector = new VectorLayer({
              source: source,
              style: new Style({
                image: new Icon({
                  src: require('@/assets/mapImage/dingwei.png')
                }),
                anchor: [0.5, 1]
              })
            });
            map.addLayer(vector);
            let draw = new Draw({
              source: source,
              type: 'Point'
            });
            map.addInteraction(draw);
            let modify = new Modify({source: source});
            map.addInteraction(modify);
            let snap = new Snap({source: source});
            map.addInteraction(snap);
            if(this.positionData.x.length>0&&this.positionData.y.length>0){
              map.removeInteraction(draw);
              const xyArr=[parseFloat(this.positionData.x),parseFloat(this.positionData.y)];
              const point = new Feature({
                geometry: new Point(xyArr)
              });
              source.addFeature(point);
              map.getView().animate({
                center: xyArr,
                zoom: 17,
                duration: 500
              })
            }
            draw.on('drawend', function (evt) {
              source.clear();
              const feature=evt.feature.clone();
              source.addFeature(feature);
            },this)
            // mapManager = new MapManager(map);
            // const drawResult=mapManager.activateDraw('Point',draw);
          })
        },
        uploadPoint(){
          const feature=source.getFeatures()[0];
          const xyData=feature.getGeometry().getCoordinates();
          let address;
          getAddress(xyData).then(res=>{
            address={
              x:xyData[0],
              y:xyData[1],
              address:res
            };
            this.$emit('getAddress',address);
            this.mapDialogVisible=false;
          })
        },
        //关闭保障视图弹窗
        handleCancel(){
          this.mapDialogVisible = false;
        }
    }
}
</script>
<style lang="scss" scoped>
.yuan_dialog_body {
  height: 400px;
  width: 100%;
  background-color: #fff;
  position: relative;
}
.upload{
  position: absolute;
  top:20px;
  right: 20px;
}
</style>
<style lang='scss'>
  .positionMapDialogWrap {
    .ant-modal-close-x {
      color: #fff;
    }
    .ant-modal-content {
      background-image: linear-gradient(90deg, #0065ea 0%, #6f62ee 100%);
      .ant-modal-header {
        background-image: linear-gradient(90deg, #0065ea 0%, #6f62ee 100%);
        // color: #fff;
        border: none;
        .ant-modal-title {
          color: #fff;
          font-size: 18px;
        }
      }
      .ant-modal-footer {
        border: 1px solid;
        border-image: linear-gradient(90deg, #0065ea 0%, #6f62ee 100%) 30 30;
        border-width: 0px 5px 10px 5px;
        background-color: #fff;
      }
    }
  }
</style>
